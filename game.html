<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Xzavior Chess</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f7f7f7; text-align: center; margin: 0; padding: 20px; }
    #chessboard {
      display: grid;
      grid-template-columns: repeat(8,1fr);
      width: 90vmin; height: 90vmin;
      max-width: 90vmin; max-height: 90vmin;
      margin: 20px auto; border: 2px solid #333;
    }
    .square { display: flex; align-items: center; justify-content: center; font-size: 6vmin; user-select: none; }
    .white { background: #f0d9b5; }
    .black { background: #b58863; }
    .selected { outline: 3px solid yellow; }
    .highlight { background: rgba(0, 255, 0, 0.4); }
    #status { margin-top: 10px; font-size: 18px; }
  </style>
</head>
<body>
  <h2>Xzavior Chess</h2>
  <div id="chessboard"></div>
  <div id="status">Loading…</div>
  <div class="mt-3">
    <button class="btn btn-warning" onclick="undoMove()">Undo</button>
    <button class="btn btn-secondary" onclick="saveGame()">Save</button>
    <button class="btn btn-danger" onclick="restartGame()">Restart</button>
    <a href="index.html" class="btn btn-dark">Home</a>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chess.js@0.13.4/chess.min.js"></script>
  <script>
    const game = new Chess();
    const board = document.getElementById("chessboard");
    const status = document.getElementById("status");
    let selected = null;

    function pieceToChar(p) {
      return { p: "♟", r: "♜", n: "♞", b: "♝", q: "♛", k: "♚",
               P: "♙", R: "♖", N: "♘", B: "♗", Q: "♕", K: "♔" }[p] || "";
    }

    function renderBoard() {
      board.innerHTML = "";
      game.fen().split(" ")[0].split("/").forEach((row, r) => {
        let col = 0;
        row.split("").forEach(ch => {
          const num = parseInt(ch);
          const count = isNaN(num) ? 1 : num;
          for (let i = 0; i < count; i++) {
            const file = "abcdefgh"[col];
            const rank = 8 - r;
            const id = file + rank;
            const square = document.createElement("div");
            square.id = id;
            square.className = "square " + ((r + col) % 2 === 0 ? "white" : "black");
            if (!isNaN(num) === false && i === 0) square.textContent = pieceToChar(ch);
            square.onclick = () => handleClick(id);
            board.appendChild(square);
            col++;
          }
        });
      });
      updateStatus();
    }

    function handleClick(id) {
      if (selected) {
        const m = game.move({ from: selected, to: id, promotion: 'q' });
        selected = null;
        renderBoard();
        if (m) setTimeout(makeComputerMove, 300);
      } else {
        const p = game.get(id);
        if (p && p.color === game.turn()) {
          selected = id;
          showHighlights(id);
        }
      }
    }

    function showHighlights(id) {
      renderBoard();
      document.getElementById(id).classList.add("selected");
      game.moves({ square: id, verbose: true })
        .forEach(m => document.getElementById(m.to)?.classList.add("highlight"));
    }

    function updateStatus() {
      if (game.in_checkmate()) status.textContent = "Checkmate!";
      else if (game.in_check()) status.textContent = "Check!";
      else status.textContent = (game.turn() === "w" ? "White" : "Black") + "'s turn";
    }

    function makeComputerMove() {
      const moves = game.moves();
      if (moves.length === 0) return;
      const move = moves[Math.floor(Math.random()*moves.length)];
      game.move(move);
      renderBoard();
    }

    window.undoMove = () => { game.undo(); renderBoard(); };
    window.saveGame = () => { localStorage.setItem("xzaviorSavedGame", game.fen()); alert("Saved!"); };
    window.restartGame = () => { if(confirm("Restart?")) { game.reset(); renderBoard(); } };

    const saved = localStorage.getItem("xzaviorSavedGame");
    if (saved) game.load(saved);
    renderBoard();
  </script>
</body>
</html>
