<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Xzavior Chess - Game</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f7f7f7;
      text-align: center;
      margin: 0;
      padding: 20px;
    }

    #chessboard {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      width: 90vmin;
      height: 90vmin;
      max-width: 90vmin;
      max-height: 90vmin;
      margin: 20px auto;
      border: 2px solid #333;
    }

    .square {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 6vmin;
      user-select: none;
      transition: all 0.2s ease;
    }

    .white { background: #f0d9b5; }
    .black { background: #b58863; }
    .selected { outline: 3px solid yellow; }
    .highlight { background-color: rgba(0, 255, 0, 0.4) !important; }
    #status { margin-top: 10px; font-size: 18px; }
  </style>
</head>
<body>
  <h2>Xzavior Chess</h2>
  <div id="chessboard"></div>
  <div id="status">Loading...</div>
  <div class="mt-3">
    <button class="btn btn-warning" onclick="undoMove()">Undo</button>
    <button class="btn btn-secondary" onclick="saveGame()">Save</button>
    <button class="btn btn-danger" onclick="restartGame()">Restart</button>
    <a href="index.html" class="btn btn-dark">Back</a>
  </div>

  <!-- Chess.js from CDN -->
  <script src="https://unpkg.com/chess.js@0.13.4/chess.min.js"></script>
  <script>
    const game = new Chess();
    const board = document.getElementById("chessboard");
    const status = document.getElementById("status");
    let selected = null;
    const config = JSON.parse(localStorage.getItem("xzaviorGameSettings") || '{}');
    const gameMode = config.mode || "human";
    const playerColor = config.side || "white";
    const difficulty = parseInt(config.difficulty || 1);

    function pieceToChar(piece) {
      const map = {
        p: "♟", r: "♜", n: "♞", b: "♝", q: "♛", k: "♚",
        P: "♙", R: "♖", N: "♘", B: "♗", Q: "♕", K: "♔"
      };
      return map[piece] || "";
    }

    function renderBoard() {
      board.innerHTML = "";
      const position = game.fen().split(" ")[0];
      const rows = position.split("/");
      rows.forEach((row, r) => {
        let col = 0;
        for (const char of row) {
          const count = isNaN(char) ? 1 : parseInt(char);
          for (let i = 0; i < count; i++) {
            const file = "abcdefgh"[col];
            const rank = 8 - r;
            const squareId = file + rank;
            const square = document.createElement("div");
            square.id = squareId;
            square.className = "square " + ((r + col) % 2 === 0 ? "white" : "black");
            if (!isNaN(char)) {
              square.textContent = "";
            } else if (i === 0) {
              square.textContent = pieceToChar(char);
            }
            square.onclick = () => handleClick(squareId);
            board.appendChild(square);
            col++;
          }
        }
      });
      updateStatus();
    }

    function handleClick(square) {
      if (selected) {
        const move = game.move({ from: selected, to: square, promotion: 'q' });
        if (move) {
          selected = null;
          renderBoard();
          if (gameMode === "computer") setTimeout(makeComputerMove, 300);
        } else {
          selected = null;
          renderBoard();
        }
      } else {
        const piece = game.get(square);
        if (piece && piece.color === game.turn()) {
          selected = square;
          highlightMoves(square);
        }
      }
    }

    function highlightMoves(square) {
      renderBoard();
      const moves = game.moves({ square, verbose: true });
      document.getElementById(square).classList.add("selected");
      moves.forEach(m => {
        const el = document.getElementById(m.to);
        if (el) el.classList.add("highlight");
      });
    }

    function updateStatus() {
      if (game.in_checkmate()) {
        status.textContent = "Checkmate! " + (game.turn() === "w" ? "Black" : "White") + " wins.";
      } else if (game.in_check()) {
        status.textContent = (game.turn() === "w" ? "White" : "Black") + " is in check.";
      } else if (game.in_draw()) {
        status.textContent = "Draw!";
      } else {
        status.textContent = (game.turn() === "w" ? "White" : "Black") + "'s turn.";
      }
    }

    function undoMove() {
      game.undo();
      if (gameMode === "computer") game.undo(); // undo computer move too
      renderBoard();
    }

    function saveGame() {
      localStorage.setItem("xzaviorSavedGame", game.fen());
      alert("Game saved!");
    }

    function restartGame() {
      if (confirm("Restart game?")) {
        game.reset();
        renderBoard();
      }
    }

    function makeComputerMove() {
      const moves = game.moves();
      if (!moves.length) return;
      let move;
      if (difficulty === 1) {
        move = moves[Math.floor(Math.random() * moves.length)];
      } else {
        const captures = game.moves({ verbose: true }).filter(m => m.captured);
        move = captures.length ? captures[Math.floor(Math.random() * captures.length)] : moves[Math.floor(Math.random() * moves.length)];
      }
      game.move(move);
      renderBoard();
    }

    const saved = localStorage.getItem("xzaviorSavedGame");
    if (saved) game.load(saved);
    renderBoard();
  </script>
</body>
</html>
