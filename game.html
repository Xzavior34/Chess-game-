<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Xzavior Chess - Game</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f7f7f7;
      margin: 0;
      text-align: center;
      padding: 20px;
    }
    #chessboard {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      width: 95vmin;
      height: 95vmin;
      margin: 0 auto;
      border: 2px solid #333;
    }
    .square {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: calc(6vmin);
      user-select: none;
    }
    .white { background: #f0d9b5; }
    .black { background: #b58863; }
    .selected { outline: 3px solid yellow; }
    .highlight { background-color: rgba(0, 255, 0, 0.4); }
    #status { margin-top: 10px; font-size: 18px; }
  </style>
</head>
<body>
  <h2 class="mb-3">Xzavior Chess</h2>
  <div id="chessboard"></div>
  <div id="status">Loading...</div>
  <div class="mt-3">
    <button class="btn btn-warning" onclick="undoMove()">Undo Move</button>
    <button class="btn btn-secondary" onclick="saveGame()">Save Game</button>
    <button class="btn btn-danger" onclick="restartGame()">Restart</button>
  </div>

  <!-- CDN: Chess.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>

  <script>
    const config = JSON.parse(localStorage.getItem("xzaviorGameSettings") || '{}');
    const game = new Chess();
    const board = document.getElementById("chessboard");
    const status = document.getElementById("status");

    let selected = null;
    let lastMoveTime = 0;

    let playerColor = config.side || "white";
    let gameMode = config.mode || "human";
    let difficulty = parseInt(config.difficulty || 1);

    function renderBoard() {
      board.innerHTML = "";
      const position = game.board();

      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
          const square = document.createElement("div");
          const file = "abcdefgh"[c];
          const rank = 8 - r;
          const id = `${file}${rank}`;
          square.id = id;
          square.className = `square ${(r + c) % 2 === 0 ? "white" : "black"}`;
          const piece = position[r][c];
          if (piece) square.textContent = pieceToChar(piece.color + piece.type);
          square.onclick = () => onClickSquare(id);
          board.appendChild(square);
        }
      }
      updateStatus();
    }

    function pieceToChar(piece) {
      const map = {
        pw: "♙", nw: "♘", bw: "♗", rw: "♖", qw: "♕", kw: "♔",
        pb: "♟", nb: "♞", bb: "♝", rb: "♜", qb: "♛", kb: "♚"
      };
      return map[piece] || "?";
    }

    function onClickSquare(square) {
      if (game.game_over()) return;
      if (selected) {
        const move = game.move({ from: selected, to: square, promotion: 'q' });
        if (move) {
          selected = null;
          renderBoard();
          if (gameMode === "computer") setTimeout(makeComputerMove, 400);
        } else {
          selected = null;
          renderBoard();
        }
      } else {
        const piece = game.get(square);
        if (piece && piece.color === game.turn()) {
          selected = square;
          highlightMoves(square);
        }
      }
    }

    function highlightMoves(square) {
      renderBoard();
      const moves = game.moves({ square, verbose: true });
      document.getElementById(square).classList.add("selected");
      moves.forEach(m => {
        const target = document.getElementById(m.to);
        if (target) target.classList.add("highlight");
      });
    }

    function updateStatus() {
      if (game.in_checkmate()) {
        status.textContent = `Checkmate! ${game.turn() === "w" ? "Black" : "White"} wins.`;
      } else if (game.in_check()) {
        status.textContent = `${game.turn() === "w" ? "White" : "Black"} is in check.`;
      } else if (game.in_draw()) {
        status.textContent = "Draw!";
      } else {
        status.textContent = `${game.turn() === "w" ? "White" : "Black"}'s turn.`;
      }
    }

    function undoMove() {
      const now = Date.now();
      if (now - lastMoveTime < 1000) return;
      game.undo(); game.undo();
      renderBoard();
      lastMoveTime = now;
    }

    function saveGame() {
      localStorage.setItem("xzaviorSavedGame", game.fen());
      alert("Game saved!");
    }

    function restartGame() {
      if (confirm("Restart the game?")) {
        game.reset();
        renderBoard();
      }
    }

    function makeComputerMove() {
      if (game.game_over()) return;
      const moves = game.moves();
      let move;
      if (difficulty === 1) {
        move = moves[Math.floor(Math.random() * moves.length)];
      } else {
        move = findBestMove(); // optional smarter logic
      }
      game.move(move);
      renderBoard();
    }

    function findBestMove() {
      const moves = game.moves({ verbose: true });
      return moves.find(m => m.captured) || moves[0];
    }

    const saved = localStorage.getItem("xzaviorSavedGame");
    if (saved) game.load(saved);
    renderBoard();
  </script>
</body>
</html>
